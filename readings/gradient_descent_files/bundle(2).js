!function(){"use strict";function e(){const e=document.createElement("div");return e.id="db-tagsug-list",e.className="suggest-overlay",document.body.appendChild(e),[new c({input:d,container:e,tmpl:u,api:l,sugOffset:{left:-1,right:-1},afterSuccess:function(e){return e?!e.cards&&!e.words||0===e.cards.length&&0===e.words.length?null:e:null},otherQuery:{debug:!0}}),new c({mode:t.LEADCHAR_SEARCH,input:d,container:e,tmpl:h,placeholder:f,api:p,supprtDirect:!0,queryName:"word",otherQuery:{count:8,alt:"xd"},sugOffset:{top:-2},afterSuccess:function(e){return e&&e.users&&0!==e.users.length?Object.assign({},e,{users:e.users.map(function(e){return Object.assign({},e,{uid:e.uid.replace(/<(\/|\\\/)?b>/g,"")})})}):null}})]}window.Do=window.Do||function(e){"function"==typeof e&&setTimeout(e,0)},Do.add_js=function(e){var t=document.createElement("script");t.src=e,document.getElementsByTagName("head")[0].appendChild(t)},Do.add_css=function(e,t){var n=document.createElement("link");n.rel="stylesheet",n.href=e,document.getElementsByTagName("head")[0].appendChild(n)},Do.check_js=function e(t,n){var r=t();r?n(r):setTimeout(function(){e(t,n)},33)},Do(function(){var e=$("#db-nav-sns"),t=$("#inp-query"),n=t.closest(".nav-search").find("label");"placeholder"in t[0]?(n.hide(),t.attr("placeholder",n.text())):(""!==t.val()&&n.hide(),t.parent().click(function(){t.focus(),n.hide()}).end().focusin(function(){n.hide()}).focusout(function(){""===$.trim(this.value)?n.show():n.hide()}).keydown(function(){n.hide()})),t.parents("form").submit(function(){if(!$.trim(t.val()).length)return!1}),e.find(".lnk-more, .lnk-account").click(function(e){e.preventDefault();var t,n=$(this),r=n.hasClass("lnk-more")?$("#db-productions"):$("#db-usr-setting");r.data("init")||(t=n.offset(),r.css({"margin-left":t.left-$(window).width()/2-r.width()+n.width()+parseInt(n.css("padding-right"),10)+"px",left:"50%",top:t.top+n.height()+"px"}),r.data("init",1),r.hide(),$("body").click(function(e){var t=$(e.target);t.hasClass("lnk-more")||t.hasClass("lnk-account")||t.closest("#db-usr-setting").length||t.closest("#db-productions").length||r.hide()})),"none"===r.css("display")?($(".dropdown").hide(),r.show()):$(".dropdown").hide()})});var t,n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},n.apply(this,arguments)},r="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},i=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e,t){!function(e,n){t&&"string"!=typeof t.nodeName?n(t):(e.Mustache={},n(e.Mustache))}(r,function(e){function t(e){return"function"==typeof e}function n(e){return v(e)?"array":typeof e}function r(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function i(e,t){return null!=e&&"object"==typeof e&&t in e}function s(e,t){return null!=e&&"object"!=typeof e&&e.hasOwnProperty&&e.hasOwnProperty(t)}function o(e,t){return m.call(e,t)}function a(e){return!o(y,e)}function c(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return w[e]})}function u(t,n){function i(e){if("string"==typeof e&&(e=e.split(k,2)),!v(e)||2!==e.length)throw new Error("Invalid tags: "+e);s=new RegExp(r(e[0])+"\\s*"),o=new RegExp("\\s*"+r(e[1])),c=new RegExp("\\s*"+r("}"+e[1]))}if(!t)return[];var s,o,c,u=[],f=[],d=[],g=!1,m=!1;i(n||e.tags);for(var y,w,$,S,T,A,O=new p(t);!O.eos();){if(y=O.pos,$=O.scanUntil(s))for(var H=0,I=$.length;H<I;++H)S=$.charAt(H),a(S)?d.push(f.length):m=!0,f.push(["text",S,y,y+1]),y+=1,"\n"===S&&function(){if(g&&!m)for(;d.length;)delete f[d.pop()];else d=[];g=!1,m=!1}();if(!O.scan(s))break;if(g=!0,w=O.scan(C)||"name",O.scan(b),"="===w?($=O.scanUntil(x),O.scan(x),O.scanUntil(o)):"{"===w?($=O.scanUntil(c),O.scan(E),O.scanUntil(o),w="&"):$=O.scanUntil(o),!O.scan(o))throw new Error("Unclosed tag at "+O.pos);if(T=[w,$,y,O.pos],f.push(T),"#"===w||"^"===w)u.push(T);else if("/"===w){if(!(A=u.pop()))throw new Error('Unopened section "'+$+'" at '+y);if(A[1]!==$)throw new Error('Unclosed section "'+A[1]+'" at '+y)}else"name"===w||"{"===w||"&"===w?m=!0:"="===w&&i($)}if(A=u.pop())throw new Error('Unclosed section "'+A[1]+'" at '+O.pos);return h(l(f))}function l(e){for(var t,n,r=[],i=0,s=e.length;i<s;++i)(t=e[i])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(r.push(t),n=t));return r}function h(e){for(var t,n,r=[],i=r,s=[],o=0,a=e.length;o<a;++o)switch(t=e[o],t[0]){case"#":case"^":i.push(t),s.push(t),i=t[4]=[];break;case"/":n=s.pop(),n[5]=t[2],i=s.length>0?s[s.length-1][4]:r;break;default:i.push(t)}return r}function p(e){this.string=e,this.tail=e,this.pos=0}function f(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function d(){this.cache={}}var g=Object.prototype.toString,v=Array.isArray||function(e){return"[object Array]"===g.call(e)},m=RegExp.prototype.test,y=/\S/,w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},b=/\s*/,k=/\s+/,x=/\s*=/,E=/\s*\}/,C=/#|\^|\/|>|\{|&|=|!/;p.prototype.eos=function(){return""===this.tail},p.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},p.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=t.length,t},f.prototype.push=function(e){return new f(e,this)},f.prototype.lookup=function(e){var n,r=this.cache;if(r.hasOwnProperty(e))n=r[e];else{for(var o,a,c,u=this,l=!1;u;){if(e.indexOf(".")>0)for(o=u.view,a=e.split("."),c=0;null!=o&&c<a.length;)c===a.length-1&&(l=i(o,a[c])||s(o,a[c])),o=o[a[c++]];else o=u.view[e],l=i(u.view,e);if(l){n=o;break}u=u.parent}r[e]=n}return t(n)&&(n=n.call(this.view)),n},d.prototype.clearCache=function(){this.cache={}},d.prototype.parse=function(t,n){var r=this.cache,i=t+":"+(n||e.tags).join(":"),s=r[i];return null==s&&(s=r[i]=u(t,n)),s},d.prototype.render=function(e,t,n,r){var i=this.parse(e,r),s=t instanceof f?t:new f(t);return this.renderTokens(i,s,n,e,r)},d.prototype.renderTokens=function(e,t,n,r,i){for(var s,o,a,c="",u=0,l=e.length;u<l;++u)a=void 0,s=e[u],o=s[0],"#"===o?a=this.renderSection(s,t,n,r):"^"===o?a=this.renderInverted(s,t,n,r):">"===o?a=this.renderPartial(s,t,n,i):"&"===o?a=this.unescapedValue(s,t):"name"===o?a=this.escapedValue(s,t):"text"===o&&(a=this.rawValue(s)),void 0!==a&&(c+=a);return c},d.prototype.renderSection=function(e,n,r,i){function s(e){return o.render(e,n,r)}var o=this,a="",c=n.lookup(e[1]);if(c){if(v(c))for(var u=0,l=c.length;u<l;++u)a+=this.renderTokens(e[4],n.push(c[u]),r,i);else if("object"==typeof c||"string"==typeof c||"number"==typeof c)a+=this.renderTokens(e[4],n.push(c),r,i);else if(t(c)){if("string"!=typeof i)throw new Error("Cannot use higher-order sections without the original template");c=c.call(n.view,i.slice(e[3],e[5]),s),null!=c&&(a+=c)}else a+=this.renderTokens(e[4],n,r,i);return a}},d.prototype.renderInverted=function(e,t,n,r){var i=t.lookup(e[1]);if(!i||v(i)&&0===i.length)return this.renderTokens(e[4],t,n,r)},d.prototype.renderPartial=function(e,n,r,i){if(r){var s=t(r)?r(e[1]):r[e[1]];return null!=s?this.renderTokens(this.parse(s,i),n,r,s):void 0}},d.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(null!=n)return n},d.prototype.escapedValue=function(t,n){var r=n.lookup(t[1]);if(null!=r)return e.escape(r)},d.prototype.rawValue=function(e){return e[1]},e.name="mustache.js",e.version="3.0.1",e.tags=["{{","}}"];var $=new d;return e.clearCache=function(){return $.clearCache()},e.parse=function(e,t){return $.parse(e,t)},e.render=function(e,t,r,i){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+n(e)+'" was given as the first argument for mustache#render(template, view, partials)');return $.render(e,t,r,i)},e.to_html=function(n,r,i,s){var o=e.render(n,r,i);if(!t(s))return o;s(o)},e.escape=c,e.Scanner=p,e.Context=f,e.Writer=d,e})});!function(e){e.SEARCH="search",e.LEADCHAR_SEARCH="leadchar-search"}(t||(t={}));var s={mode:t.SEARCH,container:null,input:null,queryName:"q",api:"",tmpl:"",render:null,leadChar:"@",itemSelector:".sug-item",hoverClass:"on",interval:30},o=[16,17,18,20,27,33,34,35,36,37,38,39,40,144],a=function(e,t){return i.to_html(e,t)},c=function(){function e(e){return this.config=Object.assign({},s,e),this.container=this.config.container,this.input=this.config.input,this.query=this.config.query,this.hoverIndex=-1,this.eventMaps=[],this.init(),this}return e.prototype.init=function(){if(!$)return console&&console.error("jQuery is not existed, we need it!"),null;if(!this.input)throw new Error('[TagSug] There is no "input" in config');if(!this.container)throw new Error('[TagSug] There is no "container" in config');this.bindEvent();var e=this.config.onInit;e&&e.call(this)},e.prototype.bindEvent=function(){var e=this,n=this.config,r=n.itemSelector,i=n.hoverClass,s=n.mode;if(this.input.addEventListener("focus",function(t){e.emit("focus",t)}),this.input.addEventListener("keydown",function(t){var n=t.keyCode;e.emit("keydown",t);var s=$(e.container),o=s.find(r),a=o?o.length:0;switch(n){case 38:var c=e.hoverIndex-1;c<0&&(c=a||-1),e.hoverIndex=c,e.emit("up",t);break;case 40:var c=e.hoverIndex+1;c>=a&&(c=-1),e.hoverIndex=c,e.emit("down",t);break;case 27:e.hide(),e.emit("cancel",t);break;case 13:if(e.hoverIndex>=0){var u=s.find("."+i).find("a")[0];u&&u.href&&(t.preventDefault(),u.click())}e.emit("enter",t,e.hoverIndex)}e.renderHover()}),this.input.addEventListener("keyup",function(n){e.emit("keyup",n);var r=n.keyCode;if(o.indexOf(r)>=0)return!1;var i=e.input.value,a=e.getCharSlices(i),c=a[0];a[1],a[2];if(!i||s===t.LEADCHAR_SEARCH&&c<0)return e.hide(),!1;e.startTimer()}),r){$(this.container).find(r).bind("mouseenter mouseleave",function(t){var n=$(t.currentTarget),r=n.index();e.hoverIndex=r,e.renderHover()})}},e.prototype.getCharSlices=function(e){var t=this.config,n=t.leadChar,r=(t.mode,e.lastIndexOf(n)),i=e.slice(0,r);return r<0?[r,e,i]:[r,e.slice(r+1),i]},e.prototype.startTimer=function(){var e=this,n=this.config,r=n.interval,i=n.otherQuery,s=n.beforeFetch,o=n.mode,a=n.queryName;this.endTimer(),this.timer=setTimeout(function(){var n,r=e.input.value,c=e.getCharSlices(r),u=c[0],l=c[1];c[2];if(l||e.renderPlaceholder(),o===t.SEARCH&&u>=0)return!1;if(o===t.LEADCHAR_SEARCH&&u<0)return!1;if(!l)return!1;e.query=l;var h=Object.assign({},i,(n={},n[a]=e.query,n));s&&(h=s(h)||s),e.fetch(h)},r)},e.prototype.endTimer=function(){clearTimeout(this.timer),this.timer=null},e.prototype.fetch=function(e){var t=this,r=this.config,i=r.api,s=r.afterSuccess,o=r.tmpl;this.xhr&&(this.xhr.abort(),this.xhr=null),this.xhr=$.getJSON(i,e,function(e){t.emit("success",n({},e));var r=s?s(e):e;t.resCache=r,t.render(o,r)})},e.prototype.render=function(e,t){if(!this.query||!e||!t)return void this.hide();var n=this.config.render,r=n?n(e,t):a(e,t);this.container.innerHTML=r,this.show()},e.prototype.renderPlaceholder=function(){var e=this.config.placeholder;e&&(this.container.innerHTML=e,this.show())},e.prototype.getPosition=function(e){var n=this.getCharSlices(e),r=(n[0],n[1],n[2]);this.$pre||this.createPre(),this.updatePre(r);var i=this.config,s=i.sugOffset,o=i.mode,a=$("<em>&nbsp;</em>"),c=$(this.input),u=c.offset();this.$pre.append(a);var l=a.position(),h=u.top+c.height()+(s&&s.top?s.top:0),p=u.left+(s&&s.left?s.left:0);return o===t.LEADCHAR_SEARCH&&(h+=l.top,p+=l.left+parseInt(c.css("paddingLeft"),10)),{top:h,left:p}},e.prototype.createPre=function(){var e=(this.config.sugOffset,$(this.input)),t={position:"absolute",left:-9999,width:e.width()+"px","font-family":e.css("font-family"),"font-size":e.css("font-size"),"word-wrap":"break-word",border:"1px"},n=$("<pre></pre>").css(t).appendTo("body");this.$pre=n},e.prototype.updatePre=function(e){this.$pre.html(e)},e.prototype.removePre=function(){this.$pre&&(this.$pre.remove(),this.$pre=null)},e.prototype.renderHover=function(){var e=this.config.itemSelector,t=this.hoverIndex;$(this.container).find(e).map(function(e,n){var r=$(n);e===t?r.addClass("on"):r.removeClass("on")})},e.prototype.hide=function(){this.container.style.display="none",this.removePre()},e.prototype.show=function(e){var t=this.getPosition(this.input.value);this.container.style.display="block";var r=n({},t,e);$(this.container).css(r)},e.prototype.on=function(e,t){var n;(this.eventMaps[e]||(n={},n[e]=[],n)).push(t)},e.prototype.emit=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=this.eventMaps[e];return!!i&&(i.forEach(function(e){e.apply(t,n)}),!0)},e}();const u='<ul class="sug-kind-search">{{#cards}}<li class="sug-item"><a href="{{url}}" class="sug-card"><img class="sug-card-cover" src="{{cover_url}}" /><div class="sug-card-info"><p class="sug-card-hd"><span class="sug-card-title">{{title}}</span><span class="sug-card-year">{{year}}</span></p><p class="sug-card-subtitle">{{card_subtitle}}</p></div></a></li>{{/cards}}{{#words}}<li class="sug-item "><a href="/search?source=suggest&q={{.}}" class="sug-word">{{.}}</a></li>{{/words}}</ul>',l="/j/search_suggest",h='<ul class="sug-people-search">{{#users}}<li class="sug-item" data-id="{{{uid}}}"><a class="sug-people" href="http://www.douban.com/people/{{uid}}"><img src="{{{avatar}}}"><em class="username">{{{username}}}</em>({{{uid}}})</a></li>{{/users}}</ul>',p="https://api.douban.com/shuo/in/complete?callback=?",f='<div class="sug-placeholder">@某人，直达其个人主页</div>',d=document.getElementById("inp-query");window.Do?Do(e):e()}();
